# ğŸš€ InsightPilot å…¨ç«¯é–‹ç™¼å·¥ç¨‹æ‰‹å†Š (SOP)

> **é©ç”¨æ¶æ§‹**ï¼šFastAPI (Backend) + Vite React (Frontend)
> **ç›®çš„**ï¼šæä¾›å¯è½åœ°ã€æ¨™æº–åŒ–çš„é–‹ç™¼èˆ‡é™¤éŒ¯æŒ‡å¼•ã€‚

---

## A. ğŸ—ºï¸ å°ˆæ¡ˆçµæ§‹åœ°åœ–

### Backend (`/backend`)

| è·¯å¾‘           | é¡å‹       | è·è²¬ (ä¸€å¥è©±èªªæ˜)                                                        |
| :------------- | :--------- | :----------------------------------------------------------------------- |
| `app/main.py`  | **å…¥å£**   | ç¨‹å¼å•Ÿå‹•é»ï¼Œè² è²¬æ›è¼‰ Middleware (CORS) èˆ‡ Routerã€‚                       |
| `app/core/`    | **æ ¸å¿ƒ**   | æ”¾è¨­å®šæª” (`config.py`)ã€è³‡æ–™åº«é€£ç·š (`db.py`)ã€åŠ å¯†é‚è¼¯ (`security.py`)ã€‚ |
| `app/models/`  | **è³‡æ–™åº«** | å®šç¾© **DB Table** çµæ§‹ (SQLAlchemy)ï¼Œå°æ‡‰çœŸå¯¦å­˜çš„è³‡æ–™ã€‚                  |
| `app/schemas/` | **é©—è­‰**   | å®šç¾© **API è¼¸å…¥/è¼¸å‡º** æ ¼å¼ (Pydantic)ï¼Œéæ¿¾ä¸æƒ³çµ¦å®¢äººçš„æ¬„ä½ã€‚           |
| `app/routers/` | **è·¯ç”±**   | å®šç¾© **API ç¶²å€**ï¼Œè² è²¬æ¥æ”¶è«‹æ±‚ -> å‘¼å«é‚è¼¯ -> å›å‚³çµæœã€‚                |
| `.venv/`       | **ç’°å¢ƒ**   | Python è™›æ“¬ç’°å¢ƒï¼Œå®‰è£å¥—ä»¶çš„åœ°æ–¹ã€‚                                        |

### Frontend (`/frontend`)

| è·¯å¾‘                        | é¡å‹     | è·è²¬ (ä¸€å¥è©±èªªæ˜)                                   |
| :-------------------------- | :------- | :-------------------------------------------------- |
| `src/main.tsx`              | **å…¥å£** | React ç¨‹å¼å•Ÿå‹•é»ï¼Œæ›è¼‰ App åˆ° HTML ä¸Šã€‚             |
| `src/App.tsx`               | **ä¸»é ** | é é¢ä¸»çµæ§‹èˆ‡è·¯ç”±è¨­å®š (Router)ã€‚                     |
| `src/services/apiClient.ts` | **å·¥å…·** | **API ç¶“ç´€äºº**ï¼Œè™•ç† BaseURLã€Tokenã€çµ±ä¸€éŒ¯èª¤æ””æˆªã€‚ |
| `src/services/xxxApi.ts`    | **API**  | å®šç¾©å…·é«”çš„ API å‘¼å«å‡½å¼ (å¦‚ `login`, `getHealth`)ã€‚ |
| `.env`                      | **è¨­å®š** | å®šç¾©ç’°å¢ƒè®Šæ•¸ (å¦‚ `VITE_API_BASE_URL`)ã€‚             |
| `vite.config.ts`            | **å»ºç½®** | Vite æ‰“åŒ…èˆ‡é–‹ç™¼ä¼ºæœå™¨è¨­å®šã€‚                         |

---

## B. ğŸ’¡ ä¸‰å€‹æ ¸å¿ƒå•é¡Œçš„æ¨™æº–ç­”æ¡ˆ

### 1. ç‚ºä»€éº¼è¦åˆ† Routers / Schemas / Modelsï¼Ÿ

é€™å«åš **é—œæ³¨é»åˆ†é›¢ (Separation of Concerns)**ã€‚

- **Models (åº«å­˜)**ï¼šä»£è¡¨**è³‡æ–™åº«çœŸç›¸**ã€‚åŒ…å«å¯†ç¢¼é›œæ¹Šã€å…§éƒ¨ IDã€‚ç›´æ¥çµ¦å‰ç«¯æœƒæ´©æ¼æ©Ÿå¯†ã€‚
  - _éŒ¯èª¤å»å“ªä¿®ï¼Ÿ_ DB é€£ç·šå¤±æ•—ã€æ¬„ä½å®šç¾©éŒ¯èª¤ â” **Models / Core**ã€‚
- **Schemas (èœå–®)**ï¼šä»£è¡¨**åˆç´„è¦ç¯„**ã€‚æ±ºå®šå‰ç«¯å‚³é€²ä¾†è¦æª¢æŸ¥ä»€éº¼ (é•·åº¦/æ ¼å¼)ï¼Œå›å‚³è¦åŒ…å«ä»€éº¼ã€‚
  - _éŒ¯èª¤å»å“ªä¿®ï¼Ÿ_ 422 Validation Errorã€ç¼ºæ¬„ä½ã€å‹åˆ¥éŒ¯èª¤ â” **Schemas**ã€‚
- **Routers (æœå‹™ç”Ÿ)**ï¼šä»£è¡¨**æµç¨‹æ§åˆ¶**ã€‚è² è²¬æ¥å®¢ (Endpoint)ã€ä¸‹å–® (Call DB)ã€é€é¤ (Response)ã€‚
  - _éŒ¯èª¤å»å“ªä¿®ï¼Ÿ_ 404 Not Foundã€401 Unauthorizedã€é‚è¼¯éŒ¯èª¤ â” **Routers**ã€‚

### 2. ç‚ºä»€éº¼å‰ç«¯è¦æœ‰ `apiClient.ts`ï¼Ÿ

é€™å«åš **å°è£ (Encapsulation)**ï¼Œé¿å…é‡è¤‡é€ è¼ªå­ã€‚

- **å®ƒè² è²¬**ï¼š
  1.  **æ‹¼æ¥ç¶²å€**ï¼šè‡ªå‹•åŠ ä¸Š `http://127.0.0.1:8000`ã€‚
  2.  **å¤¾å¸¶ Token**ï¼šè‡ªå‹•å¾ localStorage æ‹¿ Token æ”¾é€² Headerã€‚
  3.  **é è™•ç†éŒ¯èª¤**ï¼šæ””æˆª 401 è¸¢å›ç™»å…¥é ã€çµ±ä¸€æ‹‹å‡º `ApiError`ã€‚
- **å®ƒä¸è² è²¬**ï¼š
  - **UI é‚è¼¯**ï¼šä¸è¦åœ¨è£¡é¢å¯« `alert()` æˆ– `redirect()` (æœ€å¥½å›å‚³éŒ¯èª¤è®“ UI æ±ºå®šæ€éº¼é¡¯ç¤º)ã€‚
  - **ç‰¹å®šæ¥­å‹™**ï¼šä¸è¦åœ¨è£¡é¢å¯«ã€Œç™»å…¥å¾Œè¦å°å‘å“ªè£¡ã€ã€‚

### 3. é€£ä¸ä¸Š/å‡ºéŒ¯æ™‚çš„ 5 æ­¥é©Ÿå®šä½æ³•

é‡åˆ°å•é¡Œè«‹ä¾åºæª¢æŸ¥ï¼Œä¸è¦çŒœï¼š

1.  **çœ‹ Browser Network (F12)**ï¼š
    - **ç´…å­— (Status Code)** æ˜¯å¤šå°‘ï¼Ÿ(401=æ¬Šé™, 422=æ ¼å¼, 500=å¾Œç«¯çˆ†äº†, CORS=ç¶²åŸŸé™åˆ¶)
    - **Response** å…§å®¹æ˜¯ä»€éº¼ï¼Ÿ(é€šå¸¸å¾Œç«¯æœƒå›å‚³ `{ "detail": "éŒ¯èª¤åŸå› " }`)
2.  **çœ‹ Backend Console**ï¼š
    - æœ‰æ²’æœ‰éŒ¯èª¤ Tracebackï¼Ÿ(Python å ±éŒ¯é€šå¸¸å¾ˆæ¸…æ¥šï¼Œçœ‹æœ€å¾Œå¹¾è¡Œ)
3.  **çœ‹ Frontend Console (F12)**ï¼š
    - æœ‰æ²’æœ‰ JS å ±éŒ¯ï¼Ÿ(`TypeError`, `Undefined`?)
4.  **ç”¨ Swagger æ¸¬è©¦ (Backend)**ï¼š
    - æ‰“é–‹ `http://127.0.0.1:8000/docs` ç›´æ¥æ¸¬ APIã€‚
    - å¦‚æœ Swagger æœƒéä½†å‰ç«¯ä¸æœƒé â” **å‰ç«¯ apiClient æˆ– URL å¯«éŒ¯**ã€‚
    - å¦‚æœ Swagger ä¹Ÿä¸æœƒé â” **å¾Œç«¯é‚è¼¯å¯«éŒ¯**ã€‚
5.  **æª¢æŸ¥ç’°å¢ƒè¨­å®š**ï¼š
    - Frontend `.env` æŒ‡å‘çš„ Port å°å—ï¼ŸBackend å¯¦éš›è·‘åœ¨å“ªä¸ª Portï¼Ÿ

---

## C. ğŸ”’ å¾ 0 å»ºç«‹ç™»å…¥ (JWT) æª”æ¡ˆæ¸…å–®

å¦‚æœè¦å¯¦ä½œç™»å…¥åŠŸèƒ½ï¼Œä½ éœ€è¦å»ºç«‹/ä¿®æ”¹ä»¥ä¸‹æª”æ¡ˆ (æŒ‰é †åº)ï¼š

| é †åº | ç«¯  | æª”æ¡ˆè·¯å¾‘                    | ç›®çš„      | å¿…è¦å…§å®¹æ‘˜è¦                                     |
| :--- | :-- | :-------------------------- | :-------- | :----------------------------------------------- |
| 1    | å¾Œ  | `app/core/config.py`        | **è¨­å®š**  | å®šç¾© `JWT_SECRET`, `ALGORITHM`ã€‚                 |
| 2    | å¾Œ  | `app/core/db.py`            | **DB**    | è¨­å®š `SQLAlchemy engine` èˆ‡ `get_db`ã€‚           |
| 3    | å¾Œ  | `app/models/user.py`        | **Table** | å®šç¾© `User` table (id, email, password_hash)ã€‚   |
| 4    | å¾Œ  | `app/core/security.py`      | **å·¥å…·**  | å¯« `verify_password`, `create_access_token`ã€‚    |
| 5    | å¾Œ  | `app/schemas/auth.py`       | **èœå–®**  | å®šç¾© `LoginRequest`, `TokenResponse`ã€‚           |
| 6    | å¾Œ  | `app/routers/auth.py`       | **è·¯å¾‘**  | å¯« `/login` APIï¼Œå‘¼å« DB æª¢æŸ¥å¯†ç¢¼ï¼Œç™¼ Tokenã€‚    |
| 7    | å¾Œ  | `app/main.py`               | **è¨»å†Š**  | `app.include_router(auth_router)`ã€‚              |
| 8    | å‰  | `src/services/apiClient.ts` | **åº•å±¤**  | åŠ ä¸Š `setToken`, `getToken` èˆ‡ Header æ³¨å…¥é‚è¼¯ã€‚ |
| 9    | å‰  | `src/services/authApi.ts`   | **å‘¼å«**  | å¯« `login()` å‡½å¼å‘¼å«å¾Œç«¯ä¸¦å­˜ Tokenã€‚            |
| 10   | å‰  | `src/App.tsx`               | **UI**    | è£½ä½œç™»å…¥è¡¨å–®ï¼Œå‘¼å« `authApi.login()`ã€‚           |

---

## D. âœ… Debug Checklist (å‡ºéŒ¯å…ˆæª¢æŸ¥é€™è£¡)

åœ¨æ±‚æ•‘ä¹‹å‰ï¼Œè«‹å…ˆç¢ºèªé€™äº›å‹¾å‹¾éƒ½æ‰“ä¸Šäº†ï¼š

### 1. å•Ÿå‹•æª¢æŸ¥

- [ ] **Backend æœ‰è·‘å—ï¼Ÿ** (çµ‚ç«¯æ©Ÿé¡¯ç¤º `Uvicorn running on ...`)
- [ ] **Backend Port å°å—ï¼Ÿ** (é€šå¸¸æ˜¯ `8000`ï¼Œåˆ¥çœ‹éŒ¯)
- [ ] **Frontend æœ‰è·‘å—ï¼Ÿ** (çµ‚ç«¯æ©Ÿé¡¯ç¤º `Local: http://localhost:5173`)
- [ ] **Frontend Port å°å—ï¼Ÿ** (æœ‰æ²’æœ‰å› ç‚ºä½”ç”¨è·³åˆ° `5174`ï¼Ÿ)

### 2. é€£ç·šæª¢æŸ¥ (.env)

- [ ] **Frontend .env**: `VITE_API_BASE_URL` æ˜¯ `http://127.0.0.1:8000` å—ï¼Ÿ
- [ ] **æœ‰ç„¡éš±è—å­—å…ƒï¼Ÿ** .env è£¡é¢ä¸è¦æœ‰å¤šé¤˜çš„ç©ºç™½æˆ–å¼•è™Ÿã€‚

### 3. API æª¢æŸ¥

- [ ] **Method å°å—ï¼Ÿ** (GET é‚„æ˜¯ POSTï¼Ÿ)
- [ ] **Slash å°å—ï¼Ÿ** (å¾Œç«¯å¯« `/login`ï¼Œå‰ç«¯ fetch ä¸è¦å¯«æˆ `login` æˆ– `//login`)
- [ ] **CORS æœ‰é–‹å—ï¼Ÿ** (`main.py` æœ‰æ²’æœ‰åŠ  `http://localhost:5173`ï¼Ÿ)

### 4. è³‡æ–™åº«æª¢æŸ¥

- [ ] **DB æª”æ¡ˆåœ¨å—ï¼Ÿ** (Sqlite çš„ `.db` æª”æœ‰æ²’æœ‰ç”¢ç”Ÿï¼Ÿ)
- [ ] **Migration åšäº†å—ï¼Ÿ** (`Base.metadata.create_all` æœ‰åŸ·è¡Œå—ï¼Ÿ)

customers
---------
id (PK)
customer_code        # C001
last_visit_date      # date
total_spent          # int
visit_count          # int
membership_type      # string
created_at

å°æ‡‰ä½ çš„ CSV
CSV æ¬„ä½	        DB æ¬„ä½
customer_id	        customer_code
last_visit_date	    last_visit_date
total_spent	        total_spent
visit_count	        visit_count
membership_type	    membership_type